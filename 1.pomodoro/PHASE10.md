# Phase 10 — オプション実装

Phase 10では、ポモドーロタイマーアプリケーションに3つの追加機能を実装しました。

## 実装された機能

### 1. CSV インポート/エクスポート機能

ユーザーがポモドーロデータをバックアップ・移行できるよう、CSV形式でのエクスポート/インポート機能を実装しました。

#### 機能詳細

**エクスポート**
- エンドポイント: `/api/export/csv` (GET)
- ポモドーロストア内の全データをCSV形式でダウンロード
- ファイル名: `pomodoro_data_YYYYMMDD_HHMMSS.csv`
- 含まれるフィールド: id, start_time, end_time, duration_sec, status, type

**インポート**
- エンドポイント: `/api/import/csv` (POST)
- CSVファイルからデータをインポート
- 重複ID検出: 既存のIDはスキップされ、新しいデータのみがインポートされる
- エラーハンドリング: 不正なファイル形式や読み込みエラーに対応

**UI**
- 設定パネルに「CSVエクスポート」と「CSVインポート」ボタンを追加
- 通知システムで成功/エラーメッセージを表示

#### 使用方法

1. 設定アイコン（⚙️）をクリックして設定パネルを開く
2. 「データ管理」セクションで以下の操作が可能:
   - **CSVエクスポート**: ボタンをクリックしてデータをダウンロード
   - **CSVインポート**: ボタンをクリックしてCSVファイルを選択

#### テスト

7つのテストケースで検証:
- 空のストアからのエクスポート
- データを含むエクスポート
- ファイル未指定でのインポート
- 不正な拡張子のファイル
- 正常なCSVインポート
- 重複IDを持つインポート
- エクスポート→インポートのラウンドトリップ

---

### 2. WebSocket リアルタイム同期

複数のタブやデバイス間でタイマーの状態をリアルタイムに同期する機能を実装しました。

#### 機能詳細

**サーバー側（Flask-SocketIO）**
- WebSocketサーバーを実装
- 同期ルーム機能（ユーザーグループの管理）
- タイマーイベントのブロードキャスト:
  - `timer_start`: タイマー開始
  - `timer_pause`: タイマー一時停止
  - `timer_resume`: タイマー再開
  - `timer_reset`: タイマーリセット
  - `timer_complete`: タイマー完了

**クライアント側（Socket.io）**
- 自動再接続機能（最大5回の再試行）
- 同期設定の永続化（localStorage）
- 接続状態の通知表示
- 他のクライアントからのイベント受信と処理

**UI**
- 設定パネルに「リアルタイム同期」トグルを追加
- 同期の有効/無効を切り替え可能
- 接続状態の通知メッセージ

#### 使用方法

1. 設定パネルを開く
2. 「リアルタイム同期」セクションで「複数デバイス間で同期」をONにする
3. 他のタブやデバイスでも同じ操作を行う
4. タイマーの状態が自動的に同期される

#### 注意事項

- WebSocketはデフォルトで有効（テスト環境では無効）
- 同じルーム内のクライアント間でのみ同期
- ネットワーク接続が必要

#### テスト

4つのテストケースで検証:
- 本番環境でのWebSocket有効化
- テスト環境での無効化
- WebSocketモジュールのインポート
- SocketIO初期化

---

### 3. 簡易認証機能

ユーザーアカウント管理と、ユーザーごとのデータ分離を実現する認証機能を実装しました。

#### 機能詳細

**ユーザー管理**
- ユーザー登録機能
- パスワードハッシュ化（werkzeug.security）
- セッション管理
- ユーザー別データストア

**認証フロー**
- ログインページ: `/auth/login`
- 登録ページ: `/auth/register`
- ログアウト: `/auth/logout`
- 現在のユーザー取得API: `/auth/current-user`

**データ分離**
- 各ユーザーは独立したポモドーロストアを持つ
- 各ユーザーは独立したゲーミフィケーションデータを持つ
- ユーザー間でデータの干渉なし

**デモアカウント**
- ユーザー名: `demo`
- パスワード: `demo123`

#### 使用方法

**新規ユーザー登録**
1. `/auth/register` にアクセス
2. ユーザー名、パスワード（6文字以上）、メールアドレス（任意）を入力
3. 「登録」ボタンをクリック
4. 自動的にログインされ、ホーム画面にリダイレクト

**ログイン**
1. `/auth/login` にアクセス
2. ユーザー名とパスワードを入力
3. 「ログイン」ボタンをクリック

**ログアウト**
- ヘッダーのログアウトアイコン（🚪）をクリック

#### UI要素

- ヘッダーに現在のログインユーザー名を表示
- ログアウトボタンの表示/非表示
- ログイン/登録ページのレスポンシブデザイン

#### テスト

14つのテストケースで検証:
- ユーザー登録
- 重複ユーザー登録の拒否
- 認証成功
- 認証失敗（間違ったパスワード、存在しないユーザー）
- ログインページの表示
- 登録ページの表示
- ログインPOSTリクエスト
- ログアウト
- 現在のユーザー取得
- ユーザーデータの分離

---

## 技術仕様

### 依存関係

- `flask`: Webフレームワーク
- `flask-socketio`: WebSocket対応
- `python-socketio`: Socket.io実装
- `werkzeug`: パスワードハッシュ化

### ファイル構成

```
1.pomodoro/
├── app/
│   ├── auth.py              # 認証ロジック
│   ├── auth_routes.py       # 認証ルート
│   ├── websocket.py         # WebSocketハンドラー
│   └── api.py               # CSV API追加
├── static/
│   └── js/
│       ├── csv_manager.js   # CSVクライアント
│       ├── websocket_client.js  # WebSocketクライアント
│       └── auth_ui.js       # 認証UI
├── templates/
│   ├── login.html           # ログインページ
│   └── register.html        # 登録ページ
└── tests/
    ├── test_csv_export_import.py
    ├── test_websocket.py
    └── test_auth.py
```

---

## 今後の改善案

### CSV機能
- フィルタリング機能（日付範囲、タイプ別）
- 他の形式のサポート（JSON、Excel）

### WebSocket
- ルーム管理UI（ルーム作成、参加）
- プライベートルーム（パスワード保護）
- より詳細な同期状態の表示

### 認証
- パスワードリセット機能
- プロフィール編集
- データベース統合（SQLite/PostgreSQL）
- OAuth対応（Google、GitHub等）
- セッション有効期限の管理

---

## トラブルシューティング

### CSVインポートが失敗する
- CSVファイルのフォーマットを確認
- 必須フィールド（id, start_time, end_time, duration_sec, status, type）が含まれているか確認

### WebSocket接続が確立できない
- ブラウザのコンソールでエラーメッセージを確認
- ファイアウォールやプロキシの設定を確認
- Socket.ioクライアントライブラリが正しく読み込まれているか確認

### ログインできない
- ユーザー名とパスワードが正しいか確認
- デモアカウント（demo/demo123）で試す
- ブラウザのクッキーが有効になっているか確認

---

作成日: 2026-02-24
